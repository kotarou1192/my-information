# BLOG.md

現在は文章を書こうと思う場合、全く異なる書き方がいくつもあります。  
例えばブログで記事を書こうとするとサービスごとに書き方が全く違うことも多く、僕にとっては複雑すぎるように感じてしまいます。  

そこで、**markdown**というシンプルな機能を持った記法のみで好きなジャンルの記事を書くことができるブログサービスを作成しました。  

markdownは技術文書などで一般的に使われるシンプルな記述方式で、この文書もmarkdownを利用して書いています。  
markdownにも様々な分派がありますがどれも基本は同じで、文字の大きさ等や見出しなどの文字装飾、画像埋め込みやリンク挿入等を同じような記法で書くことができます。  

例えば  
```markdown
- a
- b
```
と書けば  
- a
- b

のように表示できます。

ドキュメントの記法としてmarkdownが様々な分野で普及すればいいなという思いもあります。  

フロントエンドはReactを利用したSPAなので、画面遷移時のページ再読み込みが高速です。  

利用はブラウザ(chrome)推奨です。

<https://blog-md.net>

## 機能一覧

### 実装済

- ユーザー作成
- ユーザープロフィール更新
  - プロフィール画像はS3に置き、CDNを利用して配信
  - CDNにあるコンテンツ用にcdn.blog-md.netというドメインを用意（こちらもHTTPS対応済み）
- markdownでの記事投稿・更新・削除
- キーワードでユーザー・記事の検索
  - 検索結果の表示量やページネーションも可能
- カテゴリタグを記事に付与・削除。カテゴリでグループ分けして検索や一覧表示（web-apiのみ実装済み）

### 未実装

- パスワードリセット
- ユーザーフォロー
- 記事の引用ツリー表示
  - 記事Aを引用した記事B, C, Dと、その記事Cを引用した記事D, E, Fがある場合、記事Aの画面から記事B, C, Dを一覧表示。記事Cを表示すると親である記事Aと、子である記事D, E, Fを表示する。
- いいね付与
- お問合せフォーム等のユーザーサポート

## 使い方

### ゲストアカウント利用での試用

利用テストのため、ゲスト用アカウントがあります。  
現在機能制限は特にありません。  

email: guest@blog-md.net  
password: guest-password  

### ログインをしない場合

ユーザーや記事の閲覧・検索のみができます

トップページには最新の記事が表示されています。  
表示されている記事をクリックすると、記事ページに飛びます。

上の検索欄に文字を入れエンターを押すと、ユーザーや記事を検索して閲覧できます。  
キーワードは空白で区切ってください。

### 登録する場合

登録をするとフォローや記事投稿・編集・削除をすることができます。

![img1](./buttons.png)

こちらのsign upからメールを送信し、届いたメールから登録リンクへ飛んだあとに必要情報を記入して登録ください。  

すでにアカウントを所持している場合はsign inからログインをお願いします。

## 使用した技術

#### バックエンド

- ruby
  - ruby on rails
  - capistrano
- redis
- nginx
- postgreSQL
- Google ReCAPTCHA v3

#### フロントエンド

- HTML
- CSS
- TypeScript
  - React.js
    - react-dom-router
  - Webpack
  - material-ui

#### インフラその他

- Let's Encrypt
  - CertBot
- CircleCI
- Amazon
  - Lightsail
    - ディストリビューション(CDN)
    - データベース・サーバ(postgresql)
    - Bucket
    - Instance(ubuntu)
  - AWS Route53


## 開発に際して

GitHubのイシューに欲しい機能をメモし、はじめにWebAPIから実装し、それをブラウザから扱うことができるようにしていきました。  
開発の流れは  
> issueに応じたブランチを切る -> 実装をする -> CIでテストを通してPullRequest -> merge  

上記となっています。  
コミットにもプリフィクスをつけ、何をしたかをわかりやすくするよう心がけていました。

### バックエンドに関して

- 機能ごとのテストを必ず書き、CircleCI上でそのテストが通った場合にのみ自動でデプロイするようにしています。  
  - それにより、リファクタリングにより機能が壊れていないか・仕様通りに動いているか　などのチェックを行うことができました。  
- ORMでSQLを作成するときにN+1問題などがよく発生するため、観測できたものすべてに対策を施し高速化しました。
- CORSにより、異なるオリジンのスクリプト等からのリクエストを制限しました。
- Google reCAPTCHA v3を利用し、webAPI使用者がロボットではないことを担保しました。
- AuthorizationヘッダでBearer認証で利用するトークンにJWTを利用しています。
  - RFCを読みながら自作のJWTモジュールを作成し、JWTを生成・認証しています。
- 画像に関して、Railsにアップロードされた画像をS3に載せCDNを利用して配信し、サーバーの負荷を減らすようにしました。

### フロントエンドに関して

- できるだけモダンな環境で開発するために、TypeScriptでReactを使っています。
- デプロイはCircleCIのコンテナから行っています。
- デザインに関して、はじめは生のCSSをBEM記法で手書きしてフルスクラッチしていました。
  - CSSのフルスクラッチが辛くなってきたため、フリーのCSSフレームワークを用いてReactコンポーネントを自作しました。
    - それでもデザインに満足が行かなかったため、material-uiというGoogle推奨のデザインが利用できるライブラリを利用することで満足する形になりました。
- SPAにして画面遷移のコストを抑えました。
- react-router-domを利用しており、SPAでありながらもルーティングができるようにしました。これにより、リンクの共有などが可能です。
  - インフラが絡むのですが、react-router-dom利用で#を使った仮想ルーティングを行いたくなかったため、Nginx側でどのリソースに対するアクセスでもrootディレクトリを返す設定を組みました。
- Reactのカスタムフックを作成し、hooksへの理解を深めました。
- webpackでまとめるときに1つにバンドルすると数MBと非常にサイズが大きくなるため、ライブラリとコンポーネントの2つに分けてbundleしました。
  - この配信について、HTML5のキャッシュ・マニフェストを利用してバンドルしたjsファイルをブラウザにキャッシュさせ、更新があった場合のみ再ダウンロードする形にしています。
    - HTML5のこの仕様はしばらくして非推奨となったことは把握しています。現状は代替としてService WorkerなどがSPAに向いているため、そちらへの乗り換えを検討中です。

## リポジトリ

[frontend](https://github.com/kotarou1192/blog_client)  
[backend](https://github.com/kotarou1192/blog_api)
